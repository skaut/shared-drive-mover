<script lang="ts" strictEvents>
  import LinearProgress from "@smui/linear-progress";
  import List, { Item, Separator, Subheader, Text } from "@smui/list";
  import { createEventDispatcher } from "svelte";
  import { _ } from "svelte-i18n";

  import type { ListResponse } from "../interfaces/ListResponse";
  import type { NamedRecord } from "../interfaces/NamedRecord";
  import StepHeader from "./StepHeader.svelte";

  export let step: string;
  export let path: Array<NamedRecord> = [];
  export let selected: NamedRecord | null = null;

  const dispatch = createEventDispatcher<{ error: { message: string } }>();

  let items: Array<NamedRecord> | null = null;

  function rootNavigation(): void {
    selected = null;
    path = [];
    getItems();
  }

  function breadcrumbNavigation(segment: NamedRecord): void {
    selected = null;
    path = path.slice(0, path.findIndex((item) => item.id === segment.id) + 1);
    getItems();
  }

  function itemNavigation(item: NamedRecord): void {
    selected = null;
    path = [...path, item];
    getItems();
  }

  function handleListError(type: string): void {
    switch (type) {
      case "DriveAPIError":
        dispatch("error", {
          message: $_("errorDialog.DriveAPIError"),
        });
        break;
      case "invalidParameter":
        dispatch("error", {
          message: $_("errorDialog.InvalidParameterError"),
        });
        break;
      default:
        dispatch("error", {
          message: $_("errorDialog.unknownError"),
        });
        break;
    }
  }

  function handleSharedDriveResponse(response: ListResponse): void {
    if (response.status === "error") {
      handleListError(response.type);
      return;
    }
    items = [{ id: "root", name: $_("drive.myDrive") }, ...response.response];
  }

  function handleFolderResponse(response: ListResponse): void {
    if (response.status === "error") {
      handleListError(response.type);
      return;
    }
    items = response.response;
  }

  function handleError(response: Error): void {
    dispatch("error", {
      message: $_("errorDialog.unknownErrorWithMessage") + response.message,
    });
  }

  function getItems(): void {
    items = null;
    if (path.length === 0) {
      google.script.run
        .withSuccessHandler(handleSharedDriveResponse)
        .withFailureHandler(handleError)
        .listSharedDrives();
    } else {
      google.script.run
        .withSuccessHandler(handleFolderResponse)
        .withFailureHandler(handleError)
        .listFolders(path[path.length - 1].id);
    }
  }

  getItems();
</script>

<StepHeader {step} />
<p>
  {$_("steps." + step + ".introduction")}
</p>
<List singleSelection>
  <Separator />
  <Subheader>
    <span
      class="breadcrumb"
      on:click={rootNavigation}
      on:keydown={rootNavigation}
    >
      {$_("drive.driveList")}
    </span>
    {#each path as segment (segment.id)}
      &nbsp; &gt; &nbsp;
      <span
        class="breadcrumb"
        on:click={() => {
          breadcrumbNavigation(segment);
        }}
        on:keydown={() => {
          breadcrumbNavigation(segment);
        }}
      >
        {segment.name}
      </span>
    {/each}
  </Subheader>
  <Separator />
  {#if items === null}
    <LinearProgress indeterminate />
  {:else}
    {#each items as item (item.id)}
      <Item
        selected={selected !== null && selected.id === item.id}
        on:dblclick={() => {
          itemNavigation(item);
        }}
        on:SMUI:action={() => (selected = item)}
      >
        <Text>
          {item.name}
        </Text>
      </Item>
    {/each}
  {/if}
  <Separator />
</List>

<style lang="scss">
  .breadcrumb {
    cursor: pointer;
    color: var(--mdc-theme-primary);
  }
</style>
